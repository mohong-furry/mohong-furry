#!/data/data/com.termux/files/usr/bin/bash

# GitHub‰ªìÂ∫ìÁÆ°ÁêÜÁ≥ªÁªü - Â§öËØ≠Ë®ÄÁâà
BASE_DIR="/storage/emulated/0/mohong/Github/‰ªìÂ∫ìÈõÜÂêà"

# ËØ≠Ë®ÄËÆæÁΩÆ
CURRENT_LANG="zh_CN"
LANG_FILE="$HOME/.git_manager_lang"

# Âä†ËΩΩ‰øùÂ≠òÁöÑËØ≠Ë®ÄËÆæÁΩÆ
if [ -f "$LANG_FILE" ]; then
    CURRENT_LANG=$(cat "$LANG_FILE")
fi

# ËØ≠Ë®ÄÊñáÊú¨ÂÆö‰πâ
declare -A TEXT_zh_CN TEXT_en_US

# ‰∏≠ÊñáÊñáÊú¨
TEXT_zh_CN=(
    ["title"]="GitHub‰ªìÂ∫ìÁÆ°ÁêÜÁ≥ªÁªü"
    ["enter_dir_error"]="ÈîôËØØÔºöÊó†Ê≥ïËøõÂÖ•ÁõÆÂΩï"
    ["select_operation"]="ËØ∑ÈÄâÊã©Êìç‰Ωú:"
    ["view_all_status"]="Êü•ÁúãÊâÄÊúâ‰ªìÂ∫ìÁä∂ÊÄÅ"
    ["pull_all_updates"]="ÊãâÂèñÊâÄÊúâ‰ªìÂ∫ìÊõ¥Êñ∞" 
    ["manage_single_repo"]="ÁÆ°ÁêÜÂçï‰∏™‰ªìÂ∫ì"
    ["batch_stage_commit"]="ÊâπÈáèËÆæÁΩÆÊöÇÂ≠òÂíåÊèê‰∫§"
    ["switch_language"]="ÂàáÊç¢ËØ≠Ë®Ä"
    ["exit"]="ÈÄÄÂá∫"
    ["input_choice"]="ËæìÂÖ•ÈÄâÊã©"
    ["invalid_choice"]="Êó†ÊïàÈÄâÊã©ÔºåËØ∑ÈáçËØï"
    ["repo_status"]="üìÅ ‰ªìÂ∫ìÁä∂ÊÄÅ:"
    ["synced"]="Â∑≤ÂêåÊ≠•"
    ["unsynced"]="ÊúâÊú™Êèê‰∫§Êõ¥Êîπ"
    ["normal_dir"]="ÊôÆÈÄöÁõÆÂΩï"
    ["pulling_updates"]="üîÑ ÊãâÂèñÊâÄÊúâ‰ªìÂ∫ìÊõ¥Êñ∞..."
    ["processing"]="Â§ÑÁêÜ:"
    ["all_updated"]="‚úÖ ÊâÄÊúâ‰ªìÂ∫ìÊõ¥Êñ∞ÂÆåÊàê"
    ["available_repos"]="ÂèØÁî®Git‰ªìÂ∫ì:"
    ["no_git_repos"]="‚ùå Ê≤°ÊúâÊâæÂà∞Git‰ªìÂ∫ì"
    ["select_repo_num"]="ÈÄâÊã©‰ªìÂ∫ìÁºñÂè∑:"
    ["managing_repo"]="ÁÆ°ÁêÜ‰ªìÂ∫ì:"
    ["current_branch"]="ÂΩìÂâçÂàÜÊîØ:"
    ["unknown"]="Êú™Áü•"
    ["view_status"]="Êü•ÁúãÁä∂ÊÄÅ"
    ["pull_updates"]="ÊãâÂèñÊõ¥Êñ∞"
    ["view_logs"]="Êü•ÁúãÊó•Âøó"
    ["stage_commit"]="ËÆæÁΩÆÊöÇÂ≠òÂíåÊèê‰∫§"
    ["view_untracked"]="Êü•ÁúãÊú™Ë∑üË∏™Êñá‰ª∂"
    ["return_menu"]="ËøîÂõû‰∏ªËèúÂçï"
    ["select_action"]="ÈÄâÊã©Êìç‰Ωú:"
    ["stage_commit_title"]="üìù ËÆæÁΩÆÊöÇÂ≠òÂíåÊèê‰∫§"
    ["changed_files"]="ÂèòÊõ¥Êñá‰ª∂:"
    ["stage_all"]="ÊöÇÂ≠òÊâÄÊúâÂèòÊõ¥"
    ["stage_specific"]="ÊöÇÂ≠òÊåáÂÆöÊñá‰ª∂"
    ["commit_changes"]="Êèê‰∫§ÂèòÊõ¥"
    ["stage_commit_all"]="ÊöÇÂ≠òÂπ∂Êèê‰∫§ÊâÄÊúâ"
    ["enter_files"]="ËæìÂÖ•Ë¶ÅÊöÇÂ≠òÁöÑÊñá‰ª∂Ë∑ØÂæÑÔºàÂ§ö‰∏™Êñá‰ª∂Áî®Á©∫Ê†ºÂàÜÈöîÔºâ:"
    ["files"]="Êñá‰ª∂:"
    ["enter_commit_msg"]="ËæìÂÖ•Êèê‰∫§ËØ¥Êòé:"
    ["message"]="ËØ¥Êòé:"
    ["msg_empty"]="Êèê‰∫§ËØ¥Êòé‰∏çËÉΩ‰∏∫Á©∫"
    ["all_staged"]="‚úÖ ÊâÄÊúâÂèòÊõ¥Â∑≤ÊöÇÂ≠ò"
    ["files_staged"]="‚úÖ Êñá‰ª∂Â∑≤ÊöÇÂ≠ò"
    ["changes_committed"]="‚úÖ ÂèòÊõ¥Â∑≤Êèê‰∫§"
    ["all_staged_committed"]="‚úÖ ÊâÄÊúâÂèòÊõ¥Â∑≤ÊöÇÂ≠òÂπ∂Êèê‰∫§"
    ["untracked_files"]="üìÑ Êú™Ë∑üË∏™Êñá‰ª∂:"
    ["batch_stage_title"]="üîÑ ÊâπÈáèËÆæÁΩÆÊöÇÂ≠òÂíåÊèê‰∫§"
    ["changed_repos"]="ÊúâÊú™Êèê‰∫§ÂèòÊõ¥"
    ["all_synced"]="‚úÖ ÊâÄÊúâ‰ªìÂ∫ìÈÉΩÂ∑≤ÂêåÊ≠•ÔºåÊó†ÈúÄÊìç‰Ωú"
    ["batch_operations"]="ÈÄâÊã©Êìç‰Ωú:"
    ["stage_commit_all_repos"]="‰∏∫ÊâÄÊúâ‰ªìÂ∫ìÊöÇÂ≠òÂπ∂Êèê‰∫§"
    ["stage_commit_selected"]="ÈÄâÊã©ÁâπÂÆö‰ªìÂ∫ìÊìç‰Ωú"
    ["enter_unified_msg"]="ËæìÂÖ•Áªü‰∏ÄÁöÑÊèê‰∫§ËØ¥Êòé:"
    ["select_repos"]="ÈÄâÊã©Ë¶ÅÊìç‰ΩúÁöÑ‰ªìÂ∫ìÔºàËæìÂÖ•ÁºñÂè∑ÔºåÂ§ö‰∏™Áî®Á©∫Ê†ºÂàÜÈöîÔºâ:"
    ["repo_numbers"]="‰ªìÂ∫ìÁºñÂè∑:"
    ["batch_complete"]="üéâ ÊâπÈáèÊèê‰∫§ÂÆåÊàê"
    ["selected_complete"]="üéâ ÈÄâÊã©‰ªìÂ∫ìÊèê‰∫§ÂÆåÊàê"
    ["goodbye"]="üëã ÂÜçËßÅÔºÅ"
    ["press_enter"]="ÊåâÂõûËΩ¶ÈîÆÁªßÁª≠..."
    ["language_changed"]="ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢‰∏∫‰∏≠Êñá"
    ["switch_to_english"]="ÂàáÊç¢Âà∞Ëã±Êñá"
    ["switch_to_chinese"]="ÂàáÊç¢Âà∞‰∏≠Êñá"
)

# Ëã±ÊñáÊñáÊú¨
TEXT_en_US=(
    ["title"]="GitHub Repository Management System"
    ["enter_dir_error"]="Error: Cannot enter directory"
    ["select_operation"]="Please select operation:"
    ["view_all_status"]="View all repository status"
    ["pull_all_updates"]="Pull all repository updates"
    ["manage_single_repo"]="Manage single repository"
    ["batch_stage_commit"]="Batch stage and commit"
    ["switch_language"]="Switch language"
    ["exit"]="Exit"
    ["input_choice"]="Enter choice"
    ["invalid_choice"]="Invalid choice, please try again"
    ["repo_status"]="üìÅ Repository Status:"
    ["synced"]="Synced"
    ["unsynced"]="Has uncommitted changes"
    ["normal_dir"]="Normal directory"
    ["pulling_updates"]="üîÑ Pulling all repository updates..."
    ["processing"]="Processing:"
    ["all_updated"]="‚úÖ All repositories updated"
    ["available_repos"]="Available Git repositories:"
    ["no_git_repos"]="‚ùå No Git repositories found"
    ["select_repo_num"]="Select repository number:"
    ["managing_repo"]="Managing repository:"
    ["current_branch"]="Current branch:"
    ["unknown"]="Unknown"
    ["view_status"]="View status"
    ["pull_updates"]="Pull updates"
    ["view_logs"]="View logs"
    ["stage_commit"]="Stage and commit"
    ["view_untracked"]="View untracked files"
    ["return_menu"]="Return to main menu"
    ["select_action"]="Select action:"
    ["stage_commit_title"]="üìù Stage and Commit"
    ["changed_files"]="Changed files:"
    ["stage_all"]="Stage all changes"
    ["stage_specific"]="Stage specific files"
    ["commit_changes"]="Commit changes"
    ["stage_commit_all"]="Stage and commit all"
    ["enter_files"]="Enter file paths to stage (multiple files separated by spaces):"
    ["files"]="Files:"
    ["enter_commit_msg"]="Enter commit message:"
    ["message"]="Message:"
    ["msg_empty"]="Commit message cannot be empty"
    ["all_staged"]="‚úÖ All changes staged"
    ["files_staged"]="‚úÖ Files staged"
    ["changes_committed"]="‚úÖ Changes committed"
    ["all_staged_committed"]="‚úÖ All changes staged and committed"
    ["untracked_files"]="üìÑ Untracked files:"
    ["batch_stage_title"]="üîÑ Batch Stage and Commit"
    ["changed_repos"]="Has uncommitted changes"
    ["all_synced"]="‚úÖ All repositories synced, no action needed"
    ["batch_operations"]="Select operation:"
    ["stage_commit_all_repos"]="Stage and commit for all repositories"
    ["stage_commit_selected"]="Select specific repositories to operate"
    ["enter_unified_msg"]="Enter unified commit message:"
    ["select_repos"]="Select repositories to operate (enter numbers, multiple separated by spaces):"
    ["repo_numbers"]="Repository numbers:"
    ["batch_complete"]="üéâ Batch commit completed"
    ["selected_complete"]="üéâ Selected repositories commit completed"
    ["goodbye"]="üëã Goodbye!"
    ["press_enter"]="Press Enter to continue..."
    ["language_changed"]="Language switched to English"
    ["switch_to_english"]="Switch to English"
    ["switch_to_chinese"]="Switch to Chinese"
)

# Ëé∑ÂèñÊñáÊú¨ÂáΩÊï∞
get_text() {
    local key="$1"
    local lang_var="TEXT_${CURRENT_LANG}[$key]"
    echo "${!lang_var}"
}

# ‰øùÂ≠òËØ≠Ë®ÄËÆæÁΩÆ
save_language() {
    echo "$CURRENT_LANG" > "$LANG_FILE"
}

# ÂàáÊç¢ËØ≠Ë®ÄÂáΩÊï∞
switch_language() {
    if [ "$CURRENT_LANG" = "zh_CN" ]; then
        CURRENT_LANG="en_US"
        echo "$(get_text "language_changed")"
    else
        CURRENT_LANG="zh_CN"
        echo "$(get_text "language_changed")"
    fi
    save_language
}

# ËøõÂÖ•Â∑•‰ΩúÁõÆÂΩï
cd "$BASE_DIR" || {
    echo "$(get_text "enter_dir_error") $BASE_DIR"
    exit 1
}

# ‰∏ªÂæ™ÁéØ
while true; do
    clear  # ÊØèÊ¨°ÊòæÁ§∫‰∏ªËèúÂçïÂâçÊ∏ÖÂ±è
    echo "========================================"
    echo "   $(get_text "title")"
    echo "========================================"

    echo
    echo "$(get_text "select_operation")"
    echo "1. $(get_text "view_all_status")"
    echo "2. $(get_text "pull_all_updates")"
    echo "3. $(get_text "manage_single_repo")"
    echo "4. $(get_text "batch_stage_commit")"
    if [ "$CURRENT_LANG" = "zh_CN" ]; then
        echo "5. $(get_text "switch_to_english")"
    else
        echo "5. $(get_text "switch_to_chinese")"
    fi
    echo "6. $(get_text "exit")"
    echo
    
    read -p "$(get_text "input_choice") [1-6]: " choice

    case $choice in
        1)
            echo
            echo "$(get_text "repo_status")"
            echo "----------------------------------------"
            for dir in */; do
                if [ -d "$dir/.git" ]; then
                    echo -n "‚úÖ ${dir%/}: "
                    cd "$dir"
                    if git status | grep -q "nothing to commit"; then
                        echo "$(get_text "synced")"
                    else
                        echo "$(get_text "unsynced")"
                    fi
                    cd ..
                else
                    echo "üìÇ ${dir%/}: $(get_text "normal_dir")"
                fi
            done
            ;;
        2)
            echo
            echo "$(get_text "pulling_updates")"
            for dir in */; do
                if [ -d "$dir/.git" ]; then
                    echo "$(get_text "processing") ${dir%/}"
                    cd "$dir" && git pull && cd ..
                    echo "----------------------------------------"
                fi
            done
            echo "$(get_text "all_updated")"
            ;;
        3)
            echo
            echo "$(get_text "available_repos")"
            i=1
            repo_list=()
            for dir in */; do
                if [ -d "$dir/.git" ]; then
                    echo "  $i. ${dir%/}"
                    repo_list[$i]="${dir%/}"
                    i=$((i+1))
                fi
            done

            if [ $i -eq 1 ]; then
                echo "$(get_text "no_git_repos")"
                read -p "$(get_text "press_enter")"
                continue
            fi

            echo
            read -p "$(get_text "select_repo_num"): " repo_num
            selected_repo="${repo_list[$repo_num]}"
            
            if [ -n "$selected_repo" ]; then
                cd "$selected_repo"
                
                while true; do
                    clear  # Â≠êËèúÂçïÊ∏ÖÂ±è
                    echo "========================================"
                    echo "   $(get_text "managing_repo"): $selected_repo"
                    echo "========================================"
                    echo "$(get_text "current_branch"): $(git branch --show-current 2>/dev/null || echo "$(get_text "unknown")")"
                    echo
                    echo "1. $(get_text "view_status")"
                    echo "2. $(get_text "pull_updates")"
                    echo "3. $(get_text "view_logs")"
                    echo "4. $(get_text "stage_commit")"
                    echo "5. $(get_text "view_untracked")"
                    echo "6. $(get_text "return_menu")"
                    read -p "$(get_text "select_action"): " sub_choice
                    
                    case $sub_choice in
                        1) 
                            echo
                            git status
                            ;;
                        2) 
                            echo
                            git pull
                            ;;
                        3) 
                            echo
                            git log --oneline -5
                            ;;
                        4)
                            echo
                            echo "$(get_text "stage_commit_title")"
                            echo "----------------------------------------"
                            
                            # ÊòæÁ§∫ÂèòÊõ¥Êñá‰ª∂
                            echo "$(get_text "changed_files")"
                            git status --short
                            
                            echo
                            echo "$(get_text "select_action"):"
                            echo "1. $(get_text "stage_all")"
                            echo "2. $(get_text "stage_specific")"
                            echo "3. $(get_text "commit_changes")"
                            echo "4. $(get_text "stage_commit_all")"
                            read -p "$(get_text "input_choice") [1-4]: " stage_choice
                            
                            case $stage_choice in
                                1)
                                    git add .
                                    echo "$(get_text "all_staged")"
                                    ;;
                                2)
                                    echo "$(get_text "enter_files")"
                                    read -p "$(get_text "files"): " files
                                    if [ -n "$files" ]; then
                                        git add $files
                                        echo "$(get_text "files_staged")"
                                    fi
                                    ;;
                                3)
                                    echo "$(get_text "enter_commit_msg")"
                                    read -p "$(get_text "message"): " commit_msg
                                    if [ -n "$commit_msg" ]; then
                                        git commit -m "$commit_msg"
                                        echo "$(get_text "changes_committed")"
                                    else
                                        echo "$(get_text "msg_empty")"
                                    fi
                                    ;;
                                4)
                                    echo "$(get_text "enter_commit_msg")"
                                    read -p "$(get_text "message"): " commit_msg
                                    if [ -n "$commit_msg" ]; then
                                        git add .
                                        git commit -m "$commit_msg"
                                        echo "$(get_text "all_staged_committed")"
                                    else
                                        echo "$(get_text "msg_empty")"
                                    fi
                                    ;;
                                *)
                                    echo "$(get_text "invalid_choice")"
                                    ;;
                            esac
                            ;;
                        5)
                            echo
                            echo "$(get_text "untracked_files")"
                            git status --porcelain | grep "^??" | cut -c4-
                            ;;
                        6) 
                            cd "$BASE_DIR"
                            break  # Áõ¥Êé•breakÔºåÂ§ñÂ±ÇÂæ™ÁéØ‰ºöÊ∏ÖÂ±è
                            ;;
                        *) 
                            echo "$(get_text "invalid_choice")"
                            ;;
                    esac
                    
                    if [ "$sub_choice" != "6" ]; then
                        echo
                        read -p "$(get_text "press_enter")"
                    fi
                done
            else
                echo "$(get_text "invalid_choice")"
                read -p "$(get_text "press_enter")"
            fi
            ;;
        4)
            echo
            echo "$(get_text "batch_stage_title")"
            echo "----------------------------------------"
            
            # Êî∂ÈõÜÊúâÂèòÊõ¥ÁöÑ‰ªìÂ∫ì
            changed_repos=()
            i=1
            for dir in */; do
                if [ -d "$dir/.git" ]; then
                    cd "$dir"
                    if ! git status | grep -q "nothing to commit"; then
                        echo "  $i. ${dir%/} - $(get_text "changed_repos")"
                        changed_repos[$i]="${dir%/}"
                        i=$((i+1))
                    fi
                    cd ..
                fi
            done
            
            if [ $i -eq 1 ]; then
                echo "$(get_text "all_synced")"
                read -p "$(get_text "press_enter")"
                continue
            fi
            
            echo
            echo "$(get_text "batch_operations")"
            echo "1. $(get_text "stage_commit_all_repos")"
            echo "2. $(get_text "stage_commit_selected")"
            read -p "$(get_text "input_choice") [1-2]: " batch_choice
            
            case $batch_choice in
                1)
                    echo "$(get_text "enter_unified_msg")"
                    read -p "$(get_text "message"): " batch_msg
                    if [ -n "$batch_msg" ]; then
                        for dir in */; do
                            if [ -d "$dir/.git" ]; then
                                cd "$dir"
                                if ! git status | grep -q "nothing to commit"; then
                                    echo "$(get_text "processing") ${dir%/}"
                                    git add .
                                    git commit -m "$batch_msg"
                                    echo "‚úÖ $(get_text "changes_committed")"
                                fi
                                cd ..
                            fi
                        done
                        echo "$(get_text "batch_complete")"
                    else
                        echo "$(get_text "msg_empty")"
                    fi
                    ;;
                2)
                    echo "$(get_text "select_repos")"
                    read -p "$(get_text "repo_numbers"): " repo_nums
                    
                    echo "$(get_text "enter_commit_msg")"
                    read -p "$(get_text "message"): " commit_msg
                    
                    if [ -n "$repo_nums" ] && [ -n "$commit_msg" ]; then
                        for num in $repo_nums; do
                            repo="${changed_repos[$num]}"
                            if [ -n "$repo" ]; then
                                echo "$(get_text "processing"): $repo"
                                cd "$repo"
                                git add .
                                git commit -m "$commit_msg"
                                echo "‚úÖ $(get_text "changes_committed")"
                                cd ..
                            fi
                        done
                        echo "$(get_text "selected_complete")"
                    else
                        echo "$(get_text "msg_empty")"
                    fi
                    ;;
                *)
                    echo "$(get_text "invalid_choice")"
                    ;;
            esac
            read -p "$(get_text "press_enter")"
            ;;
        5)
            switch_language
            read -p "$(get_text "press_enter")"
            ;;
        6)
            echo "$(get_text "goodbye")"
            exit 0  # ÈÄÄÂá∫Á®ãÂ∫èÔºå‰∏çÈúÄË¶ÅÊ∏ÖÂ±è
            ;;
        *)
            echo "$(get_text "invalid_choice")"
            read -p "$(get_text "press_enter")"
            ;;
    esac
done